<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Espiral Climática</title>
  <style>
    body {
      background: black;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }
    canvas {
      background-color: black;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Espiral Climática</h2>
  <canvas id="canvas" width="800" height="800"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const r = 180;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const rFactor = r / 3.6;

    // Carrega o CSV automaticamente
    fetch("HadCRUT.5.0.2.0.analysis.summary_series.global.monthly.csv")
      .then(response => {
        if (!response.ok) throw new Error("Erro ao carregar o CSV.");
        return response.text();
      })
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: function(results) {
            drawSpiral(results.data);
          }
        });
      })
      .catch(error => {
        console.error("Erro:", error);
        alert("Não foi possível carregar o arquivo CSV.");
      });

    function polarToCartesian(angle, radius) {
      return {
        x: centerX + radius * Math.cos(angle),
        y: centerY + radius * Math.sin(angle)
      };
    }

    function drawSpiral(data) {
      const anomalies = data.map(row => row["Anomaly (deg C)"]);
      const dates = data.map(row => row["Time"]);
      let frame = 0;

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Fundo preto e círculos de referência
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "gray";
        for (let val = 1.0; val <= 5.0; val++) {
          ctx.beginPath();
          ctx.arc(centerX, centerY, val * rFactor, 0, 2 * Math.PI);
          ctx.stroke();
        }

        // Espiral
        for (let i = 1; i < frame; i++) {
          const angle1 = (2 * Math.PI / 12) * (i % 12);
          const angle2 = (2 * Math.PI / 12) * ((i + 1) % 12);
          const radius1 = (anomalies[i] + 3) * rFactor;
          const radius2 = (anomalies[i + 1] + 3) * rFactor;

          const p1 = polarToCartesian(angle1, radius1);
          const p2 = polarToCartesian(angle2, radius2);

          const temp = anomalies[i];
          const color = temp < 0
            ? `rgba(0,0,255,${Math.min(1, Math.abs(temp)/3.6)})`
            : `rgba(255,0,0,${Math.min(1, temp/3.6)})`;

          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        }

        // Texto do ano
        if (dates[frame]) {
          const year = dates[frame].split("-")[0];
          ctx.fillStyle = "white";
          ctx.font = "28px sans-serif";
          ctx.fillText(year, centerX - 30, centerY + 10);
        }

        if (frame < anomalies.length - 1) {
          frame++;
          requestAnimationFrame(animate);
        }
      }

      animate();
    }
  </script>
</body>
</html>
